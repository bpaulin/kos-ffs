////////////////////////////////////////////////////////////////////////////////
// Descent
//
// leave everything til a given stage, warp til ground
////////////////////////////////////////////////////////////////////////////////
declare parameter maxStage.
declare parameter maxWarp is 0.

run once lib_message.

sas off.

////////////////////////////////////////////////////////////////////////////////
// Stage til right number
////////////////////////////////////////////////////////////////////////////////
detailMessage("Descent", "Stage to #" + maxStage).
until stage:number = maxStage {
  stage.
}

////////////////////////////////////////////////////////////////////////////////
// Warp
////////////////////////////////////////////////////////////////////////////////
detailMessage("Descent", "Warp to " + maxWarp).
set warp to maxWarp.
wait until altitude<body:atm:height.
set warpmode to "physics".
set warp to maxWarp.

////////////////////////////////////////////////////////////////////////////////
// steering and chutes
////////////////////////////////////////////////////////////////////////////////
lock steering to retrograde.
detailMessage("Descent", "Prepare Chutes.").
when (not chutessafe) then {
  chutessafe on.
  unlock steering.
  return (not chutes).
}

////////////////////////////////////////////////////////////////////////////////
// landed!
////////////////////////////////////////////////////////////////////////////////
wait until ship:status="landed" or ship:status="splashed".
sas off.
