////////////////////////////////////////////////////////////////////////////////
// Descent
//
// leave everything til a given stage, warp til ground
////////////////////////////////////////////////////////////////////////////////
declare parameter maxStage.
declare parameter maxWarp is 0.

run once lib_message.
run once lib_math.
run once lib_utils.

sas off.

////////////////////////////////////////////////////////////////////////////////
// Warp
////////////////////////////////////////////////////////////////////////////////
detailMessage("Descent", "Warp to " + maxWarp).
set warp to maxWarp.
wait until altitude<body:atm:height+5000.
panels off.

////////////////////////////////////////////////////////////////////////////////
// Stage til right number
////////////////////////////////////////////////////////////////////////////////
detailMessage("Descent", "Stage to #" + maxStage).
dropStageTo(maxStage).

////////////////////////////////////////////////////////////////////////////////
// steering and chutes
////////////////////////////////////////////////////////////////////////////////
detailMessage("Descent", "Prepare Chutes.").
set steeringmanager:pitchts to 5.
set steeringmanager:yawts to 5.
lock steering to retrograde.
wait 2.
set warpmode to "physics".
set warp to maxWarp.
when (not chutessafe) then {
  chutessafe on.
  unlock steering.
  return (not chutes).
}

////////////////////////////////////////////////////////////////////////////////
// landed!
////////////////////////////////////////////////////////////////////////////////
wait until ship:status="landed" or ship:status="splashed".
set warp to 0.
sas off.
